<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.15">
<meta name="author" content="Author Marek Scholle">
<title>Gradus ad IO Parnassum</title>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap');

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  #toctitle {
    color: royalblue;
    text-align: left;
    font-family: 'Fira Sans', sans-serif;
    font-weight: 300;
  }

  body {
    font-family: 'Fira Sans', sans-serif;
  }

  code {
    font-family: 'JetBrains Mono', monospace;
    font-variant-ligatures: contextual;
  }

  pre {
    font-family: 'JetBrains Mono', monospace;
  }

  #content {
    text-align: justify;
  }

  #header,
  #content {
    max-width: 800px;
  }
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Gradus ad IO Parnassum</h1>
<div class="details">
<span id="author" class="author">Author Marek Scholle</span><br>
<span id="email" class="email"><a href="mailto:marekscholle@gmail.com">marekscholle@gmail.com</a></span><br>
<span id="revnumber">version 0.1,</span>
<span id="revdate">2021-06-26</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_prerequsities">1. Prerequsities</a>
<ul class="sectlevel2">
<li><a href="#_sealed_traits">1.1. Sealed traits</a></li>
<li><a href="#_tail_recursion">1.2. Tail recursion</a></li>
</ul>
</li>
<li><a href="#_gradus_ad_program">2. Gradus ad <code>Program</code></a>
<ul class="sectlevel2">
<li><a href="#_step_no_1">2.1. Step No. 1</a></li>
<li><a href="#_step_no_2">2.2. Step No. 2</a>
<ul class="sectlevel3">
<li><a href="#_example">2.2.1. Example</a></li>
</ul>
</li>
<li><a href="#_step_no_3">2.3. Step No. 3</a></li>
<li><a href="#_step_no_4">2.4. Step No. 4</a></li>
<li><a href="#_naive_interpreter_for_program">2.5. Naive interpreter for <code>Program</code></a></li>
<li><a href="#_tail_recursive_rewrite_of_naive_interpreter">2.6. Tail-recursive rewrite of naive interpreter</a>
<ul class="sectlevel3">
<li><a href="#_example_compute_parity_of_length_of_list">2.6.1. Example: compute parity of length of list</a></li>
</ul>
</li>
<li><a href="#_interpreter_of_program">2.7. Interpreter of <code>Program</code></a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This is my attempt to introduce IO monad programming for those
who never heard about it.
Unlike material I myself found when I first met the concept,
this does not try to &#8220;sell&#8221; it from the beginning
as purely functional, referentially transparent solution,
but rather as a smart way to organize computation,
to get concurrent execution of subprograms virtually for free
and without magic, and to avoid stack overflows.</p>
</div>
<div class="paragraph">
<p>The language I choose for presenting ideas is
<a href="https://www.scala-lang.org">Scala 3</a>, which is one of JVM languages.
I intentionally avoid using advanced Scala feautures and syntax sugar
(like
<a href="https://docs.scala-lang.org/tour/for-comprehensions.html">for comprehension</a>
or <a href="https://docs.scala-lang.org/tour/by-name-parameters.html">by-name parameters</a>),
so that even a reader without prior knowledge will understand.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequsities"><a class="anchor" href="#_prerequsities"></a>1. Prerequsities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is supposed that a reader already knows basics of generic Java-like
OOP typed programming
(classes, instances, functions, generics) and the term <em>interface</em>
as prescription of functionality which must be implemented
by type implementing the interface.
Classic example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">trait Animal:
  def name: String
  def makeSound: String
  def introduceSelf(): Unit =
    println(s"Hi! I'm $name and I do '$makeSound'!")</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<a href="https://docs.scala-lang.org/tour/traits.html">Traits</a> are
similar to Java interfaces.
Returning <code>Unit</code> is a Scala&#8217;s way of saying &#8220;return nothing&#8221;,
like <code>void</code> in C++ or Java. The <code>Unit</code> is the 0-tuple type,
and its only instance has a special (natural) notation: <code>()</code>.
I some sense it is an equavilent of Python&#8217;s <code>None</code> –
if you specify that a function returns <code>Unit</code>,
you don&#8217;t need to return <code>()</code> explicitely,
it is returned automatically.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Any (concrete) type implementing <code>Animal</code> trait has to implement
methods <code>name</code> and <code>makeSound</code>, and the method <code>introduceSelf</code>
is (by default) implemented in terms of these two methods.
One way to get an instance of <code>Animal</code> is to define <em>anonymous</em>
implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">val bob = new Animal:
  def name: String = "Bob"
  def makeSound: String = "Woof"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run <code>bob.introduceSelf()</code>, we will get <code>Hi! I&#8217;m Bob and I do 'Woof'!</code>
in the console.</p>
</div>
<div class="paragraph">
<p>As this runs in JVM, we mostly don&#8217;t care about object lifecycles;
as long as we can reach an object (through chain of references)
it lives on the heap.</p>
</div>
<div class="sect2">
<h3 id="_sealed_traits"><a class="anchor" href="#_sealed_traits"></a>1.1. Sealed traits</h3>
<div class="paragraph">
<p>In the text we will use one convenience of Scala language: <em>sealed traits</em>.
Marking an interface as <em>sealed</em> tells the compiler there will be no other
implementations than those provided in the same file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">/** Skeleton of naive implementation of generic `Option` type with
  * two variants: empty ([[None]]) and present ([[Some]]).
  * No one outside the file can extend `Option[A]`.
  */
sealed trait Option[A]
  def get: A
  def map(f: A =&gt; B): Option[B]

object Option:
  case class None[A]() extends Option[A]
    def get: A = throw NoSuchElementException
    def map(f: A =&gt; B): None[B] = None()

  case class Some[A](value: A) extends Option[A]
    def get: A = value
    def map(f: A =&gt; B): Some[B] = Some(f(value))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The benefit is that if we have an instance <code>opt</code> of type <code>Option[A]</code>,
the compiler knows what are all possible variants and provides us a way to
do complete <em>pattern matching</em> on the instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">opt match
  case Some(value) =&gt; // handle the "present" case
  case None        =&gt; // handle the "empty" case</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tail_recursion"><a class="anchor" href="#_tail_recursion"></a>1.2. Tail recursion</h3>
<div class="paragraph">
<p>If you don&#8217;t know what it is, let&#8217;s start with a simple recursive function
which sums integers from 1 to <code>n</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def sum(n: Int): Int =
  assert(n &gt;= 0)
  if (n == 0) 0
  else n + sum(n - 1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run <code>sum(1_000_000)</code> we get stack overflow –
when executing <code>sum</code> for an <code>n &gt; 0</code>,
the compiler must first create a stack frame to compute
<code>sum(n - 1)</code> and <em>only then</em> it can add <code>n</code> and return.
The  important thing here is that there is a work to do
<em>after</em> the recursive call.</p>
</div>
<div class="paragraph">
<p>On the contrary, the program</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def helloWorldForever(): Nothing
  println("Hello, world")
  helloWorldForever()</code></pre>
</div>
</div>
<div class="paragraph">
<p>will (in Scala) not cause stack overflow: the compiler is smart
enough to see that it can <em>reuse</em> the stack frame for <code>helloWorldForever</code>
for another call of it.</p>
</div>
<div class="paragraph">
<p>Scala has a special annotation for checking that a recursive function
boiles down to a tail-recursive one: <code>@tailrec</code>.
If we apply this annotation to our <code>sum</code> example,
we get a compilation error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">@tailrec def sum(n: Int): Int =
  if (n == 0) 0
  else (n + sum(n - 1))
          ^
error: could not optimize @tailrec annotated method sum: it contains
a recursive call not in tail position</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tail-recursion is good: it is cheaper than the usual one
and we don&#8217;t risk stack overflows.
It is a viable replacement for imperative loops:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def imperativeSum(n: Int) =
  var acc = 0
  (1 to n).forEach { i =&gt; acc += i }
  acc</code></pre>
</div>
</div>
<div class="paragraph">
<p>is better written (without any mutation)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def sum(n: Int) =
  @tailrec
  def loop(n: Int, acc: Int) =
    if (n == 0) acc
    else loop(n - 1, n + acc)
  loop(n, 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The trick to turn an imperative loop to <code>@tailrec</code> recursion
by making local mutable variable a helper <code>@tailrec</code> function parameter
is not uncommon, but requires some practise.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gradus_ad_program"><a class="anchor" href="#_gradus_ad_program"></a>2. Gradus ad <code>Program</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>We start with a question how we can represent a <em>program</em> in our code.
This may raise questions</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Why we would do that?</p>
</li>
<li>
<p>What&#8217;s wrong with writing of program starting from main function
and calling other functions?</p>
</li>
<li>
<p>What&#8217;s the difference between a function (like the main one) and
your  &#8220;program&#8221;?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of course, there is nothing wrong with code starting from main function
and calling other functions.
But as we will see, formulating what is a &#8220;program&#8221; will provide us
some non-trivial benefits; it will provide us a way to <em>implement</em> some
concepts that usually must be provided by language itself
(and often are not).</p>
</div>
<div class="sect2">
<h3 id="_step_no_1"><a class="anchor" href="#_step_no_1"></a>2.1. Step No. 1</h3>
<div class="paragraph">
<p>Our first attempt to represent an executable piece of code may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">trait Program1:
  def execute(): Unit</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Program1</code> is a minimal version of <em>program</em> which does not take any arguments
and returns nothing.
It is the same as Java&#8217;s
<a href="https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/Runnable.html">
<code>Runnable</code></a>,
people coming from C background would maybe call this a <em>callback</em> type
as this type is a natural candidate for callbacks fired when something happens.</p>
</div>
<div class="paragraph">
<p>As it does return nothing, it is not much useful.
The only thing we can do is a primitive chain operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">trait Program1:
  def execute(): Unit // abstract

  /** Program which first executes `this` program
    * and then the `that` program.
    */
  def andThen(that: Program1): Program1 =
    val self = this
    new Program1:
      def execute(): Unit =
        self.execute()
        that.execute()</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, given two programs <code>p</code> and <code>q</code>, we can easily create a program which
sequentially executes both: <code>p.andThen(q)</code>. We can pass an instance of
<code>Program1</code> as argument to some function which may (and may not)
execute the piece of code suspended in <code>execute</code> method.
(This what you do in Java when you pass a <code>Runnable</code> instance
to <code>Thread</code> constructor.)</p>
</div>
<div class="paragraph">
<p>It is worth noting that the requirement that <code>Program1</code> does not
accept any arguments does not limit us: we can capture (&#8220;bake&#8221;)
whatever we want into an instance of <code>Program1</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">val a = 1
val b = 2
val program = new Program1:
  def execute(): Unit =
    // the references to `a` and `b` are captured into this
    // anonymous `Program1`'s state, so we can refer to them
    // as if with `this.a` and `this.b`
    println(s"$a + $b = ${a + b}")</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is generally useful to ask what is a minimal example of interfaces
we meet: for a set, it would be an empty set, for <code>Program1</code>, it is
a program which accepts nothing, does nothing and returns nothing
(which means compiler will rewrite it to return <code>()</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">val doNothing = new Program1:
  def execute(): Unit = {}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_no_2"><a class="anchor" href="#_step_no_2"></a>2.2. Step No. 2</h3>
<div class="paragraph">
<p>The (obvious) problem is that we <code>execute</code> a <code>Program1</code> just
for its <em>side effect(s)</em>: sure, we can print its result to console,
to file, to database, or to save it to some agreed-before piece of memory,
but of course this is clumsy.
The natural thing to do is to make the program generic in its <em>return type</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">trait Program2[A]:
  def execute(): A</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is much better.
As before, we don&#8217;t need <code>Program2</code> to accept arguments for <code>execute</code> method
as we can bake whatever we need directly into instance of <code>Program2</code>.
The difference is that the execution of program now has means
to return its result without modifying external world.
Please note that <code>Program2</code> is a direct generalization of <code>Program1</code>
which is the same as <code>Program2[Unit]</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s examine what we can do with <code>Program2</code>.
As we now have a meaningful result of execution,
we can create a new program by remaping the result of another one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">trait Program2[A]:
  def execute(): A // abstract

  /** Program which executes `this` program, passes the result
    * as argument to `f` and returns its result.
    */
  def map[B](f: A =&gt; B): Program2[B] =
    val self = this
    new Program2[B]:
      def execute(): B =
        val a = self.execute()
        f(a)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hence, given a function <code>f: A =&gt; B</code>, we can easily transform
a <code>Program2[A]</code> to <code>Program2[B]</code>
by applying <code>f</code> on the result of the former one.
(Note that <code>Program2[A].map[B]</code> only schedules this operation for execution
when the resulting program is executed, it does not call it itself.)
In other words (more elaborately), <code>map</code> is an operation which takes
a <code>Program2[A]</code> (implicit <code>this</code>), a function <code>A =&gt; B</code> and returns
<code>Program2[B]</code>.</p>
</div>
<div class="paragraph">
<p>So far we have not done anything surprising or unclear:
we just have crafted an interface (<code>Program2</code>) to wrap
a function (<code>execute</code>) with baken-into arguments,
with convenient syntax to apply a transformation on the result (<code>map</code>).
Now we will introduce first non-obvious thing:
if we substitute <code>B === Program[C]</code> in <code>map[B](f: A =&gt; B)</code>,
we meet a type for a <em>program producing another program</em>
since the return type of <code>map(f: A =&gt; Program[C])</code> is <code>Program[Program[C]]</code>.</p>
</div>
<div class="paragraph">
<p>Not suprisingly, <code>Program[Program[C]]</code> belongs
to &#8220;family&#8221; of programs producing a <code>C</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you know <code>Future[A]</code> (or <code>Promise&lt;A&gt;</code> in Javascript),
an analogy is at hand: <code>Future[A]</code> is a &#8220;container for future value&#8221;,
or a &#8220;value that will be known in some point in the future&#8221;.
The type <code>Future[Future[A]]</code> thus represents a &#8220;future value in some point
in the future&#8221;, which is still a value in future (with some known
intermediate step).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The proof of this claim is a function which takes a <code>Program2[Program2[A]]</code>
and returns a <code>Program2[A]</code>; a function of &#8220;shape&#8221; <code>F[F[A]] =&gt; F[A]</code>
is usually called <code>flatten</code>.
The implementation is trivial and is in fact the <em>only possible</em> implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">// free-standing function, not part of `trait Program2[A]`
def flatten(program: Program2[Program2[A]]): Program2[A] =
  new Program2[A]:
    def execute(): A =
      program.execute().execute()</code></pre>
</div>
</div>
<div class="paragraph">
<p>In words: to produce an <code>A</code> from <code>Program2[Program2[A]]</code>,
we must execute the outer <code>Program2</code> to get (inner) <code>Program2[A]</code>
which we then execute to get wanted <code>A</code>.</p>
</div>
<div class="paragraph">
<p>It is now only an intelectual curiosity to produce a program producing
program, but soon we will see how useful this is. Usually we don&#8217;t
write <code>flatten(program.map(f))</code>, where <code>program</code> is a <code>Program2[A]</code>
and <code>f</code> is an <code>A =&gt; Program[B]</code>, but use map and flatten in a single
step called <code>flatMap</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">trait Program2[A]:
  def execute(): A

  /** Program which first executes `this` program and passes the result
    * as argument to `f` to obtain another program which is then executed
    * and its result returned.
    */
  def flatMap[B](f: A =&gt; Program2[B]): Program2[B] =
    val self = this
    new Program2[B]:
      def execute(): B =
        val a = self.execute()
        f(a).execute()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note this is in fact <em>the</em> direct transformation of <code>andThen</code> from
<code>Program1</code> (with regard to generalization of <code>Program1</code> to <code>Program2[A]</code>):
just with <code>Program2[A]</code> we can use the result of the first
program to <em>create</em> the second one; in other words, &#8220;bake&#8221; the result
of the first program into the second one as additional argument
(known only after first program has been executed and its result is known).</p>
</div>
<div class="paragraph">
<p>As with <code>Program1</code>, it is good to ask what is the minimal
implementation of <code>Program2[A]</code>. It is the program which just returns
a value which we already know (again, <code>ready[Unit]</code> is equavalent to
<code>Program1</code>'s <code>doNothing</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def ready[A](a: A): Program2[A] =
  new Program2[A]:
    def execute(): A = a</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is worth noting that when we have <code>flatMap</code> operation
and the <code>ready</code> factory,
we implement <code>map</code> operation in terms of these two:
the equivalence is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">program.map(f) === program.flatMap { x =&gt; ready(f(x)) }</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Please reread the contracts of <code>map</code>, <code>flatMap</code> and <code>ready</code> to confirm
this is not a lie.)
I intentionally use the term <em>equivalence</em> to avoid confusion with <em>equality</em>,
the left hand and right hand expressions represent the same logical programs,
but are not equal as object instances.</p>
</div>
<div class="sect3">
<h4 id="_example"><a class="anchor" href="#_example"></a>2.2.1. Example</h4>
<div class="paragraph">
<p>Let us write a simple program using our <code>Program2</code>.
As an example we take a well known recursive
problem
(<a href="https://en.wikipedia.org/wiki/Collatz_conjecture">Collatz conjecture</a>)
which goes this way: given a positive number <code>n</code>,
if it is odd, mutliply it by 3 and add 1
(hence the name <em>3n + 1 problem</em>) and repeat,
if it is even, divide by 2 and repeat.
The Collatz conjecture states that for every starting <code>n</code>,
you will eventually reach the cycle 1, 2, 4.
Let&#8217;s implement a program which, for given <code>n</code>,
computes the number of steps until the sequence reaches 1.
(Example: for <code>n</code> = 6, the sequence is 3, 10, 5, 16, 8, 4, 2, 1
and hence the result is 8).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def collatz(n: BigInt): Program2[BigInt] =
  new Program2[BigInt]:
    def execute(): BigInt =
      if (n == 1) 0
      else
        val c =
          if (n % 2 == 0) collatz(n / 2)
          else collatz(3 * n + 1)
        c.map(_ + 1).execute()</code></pre>
</div>
</div>
<div class="paragraph">
<p>To check the result of this program, let&#8217;s introduce another program
for printing a labeled value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def print[A](label: String, a: A): Program2[Unit] =
  new Program2[Unit]:
    def execute(): Unit =
      println(s"$label: $a")</code></pre>
</div>
</div>
<div class="paragraph">
<p>The program which, for given <code>n</code>, computes the lenght of
<code>3n + 1</code> sequence and prints its length, is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def collatzAndPrint(n: BigInt): Program2[Unit] =
  collatz(n).flatMap { len =&gt; print(s"length($n)", len) }</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we <code>execute</code> the program <code>collatzAndPrint(8)</code>,
we will see <code>length(6): 8</code> as expected.
As you can observe (or verify),
this implementation extensively uses stack
(you would need to find a very large <code>n</code> to overflow the stack though).
Moreover, the implementation is hardly in any sense better than plain</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def collatz(n: BigInt): BigInt =
  if (n == 1) 0
  else
    val c =
      if (n % 2 == 0) collatz(n / 2)
      else collatz(3 * n + 1)
    c + 1</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_no_3"><a class="anchor" href="#_step_no_3"></a>2.3. Step No. 3</h3>
<div class="paragraph">
<p>Let summarize what we have in single listing.
(We delegate <code>flatMap</code> to a free-standing function in companion object
which acts as namespace so that <code>ready</code> and <code>flatMap</code> are both
free-standing functions.)
The <code>map</code> operation is implemented in terms
of <code>ready</code> and <code>flatMap</code>; it is not treated as &#8220;a primitive&#8221; operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">trait Program3[A]:
  def execute(): A

  def map[B](f: A =&gt; B): Program3[B] =
    flatMap { a =&gt; Program3.ready(a) }

  def flatMap[B](f: A =&gt; Program3[B]): Program3[B] =
    Program3.flatMap(this, f)

object Program3:
  def ready[A](a: A): Program3[A] =
    new Program3[A]:
      def execute(): A = a

  def flatMap[A, B](
      program: Program3[A],
      f: A =&gt; Program3[B],
  ): Program3[B] =
    new Program3[B]:
      def execute(): B =
        f(program.execute()).execute()

  def flatten[A](program: Program2[Program2[A]]): Program2[A] =
    // `identity` is the generic identity function function x |-&gt; x
    program2.flatMap(identity)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We already have much than one might expect,
but the question if it is useful is still not answered.
The basic problem is that we force <code>Program3</code> to provide <code>execute</code>
method, and once we call it,
the program has no option but to do everything it can to produce
the output, blocking the thread and growing the stack during its execution.
It is nothing more than just a funny form of normal functions,
we only bake arguments into instances of <code>Program2</code> (usually anonymous)
and name the function call as <code>execute</code>.</p>
</div>
<div class="paragraph">
<p>To see benefits of such programs, we must do one non-obvious step
(maybe surprising for those from OOP world):
remove the <code>execute</code> method from the interface and thus <em>relieve</em> programs
from the concern of their <em>execution</em>.
Note we started with <code>Program1</code> which had nothing but <code>execute</code>,
and now we remove this <code>execute</code> from the interface and
are finding something which will drive programs execution:
the <em>interpreter</em>.
(I used the term <em>interpreter</em> to avoid confusion
with threading task scheduling mechanisms called <em>executors</em>.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_no_4"><a class="anchor" href="#_step_no_4"></a>2.4. Step No. 4</h3>
<div class="paragraph">
<p>So we remove <code>execute</code> from <code>Program3</code> and get</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">sealed trait Program[A]:
  def map[B](f: A =&gt; B): Program[B] =
    flatMap { a =&gt; Program.ready(a) }
  def flatMap[B](f: A =&gt; Program[B]): Program[B] =
    Program.FlatMap(this, f)

object Program:
  /** Program which returns an already existing value. */
  private case class Ready[A](a: A) extends Program[A]

  /** Program which (when interpreted) executes the `program`,
    * applies `f` on its result to get an another program, runs it
    * and returns its result.
    */
  private case class FlatMap[A, B](
      program: Program[A],
      f: A =&gt; Program[B],
  ) extends Program[B]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we now don&#8217;t have anything to do in <code>flatMap</code>
implementation, so we just <em>save</em> the parameters to a (named) case
of <code>Program[A]</code> in the hope that something (interpreter)
will use it when executing the program.
I use <code>private</code> for the cases to denote that a client shall
use factories to create <code>Program</code>s, and not refer to
concrete implementations directly.</p>
</div>
<div class="paragraph">
<p>As before, we have the minimal implementation of <code>Program[A]</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def ready[A](a: A): Program[A] = Ready(a)</code></pre>
</div>
</div>
<div class="paragraph">
<p>With what we already have, let&#8217;s prepare two other factories for <code>Program</code>s:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def suspend[A](f: () =&gt; A): Program[A] =
  ready(()).map(f)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This factory <em>suspends</em> the supplied function into a <code>Program[A]</code>,
when the program is executed (by interpreter),
the result of the suspended function is used as the result of the program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def defer[A](f: () =&gt; Program[A]): Program[A] =
  ready(()).flatMap(f)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This factory suspends the supplied function which produces a program.
When the the result of <code>defer</code> is executed (by interpreter), we first
run the function <code>f</code> to obtain a program which is executed next
to obtain the program result.</p>
</div>
<div class="paragraph">
<p>Please note that no one requires (and has any means to force) that
parameters of <code>map</code> and <code>flatMap</code> do not do any side effects,
on the contrary it very common (especially in <code>flatMap</code> or <code>defer</code>)
to do them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_naive_interpreter_for_program"><a class="anchor" href="#_naive_interpreter_for_program"></a>2.5. Naive interpreter for <code>Program</code></h3>
<div class="paragraph">
<p>Let&#8217;s write <em>some</em> interpreter for <code>Program[A]</code> just to prove that
by removing <code>execute</code> from <code>Program</code> interface we lose nothing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def run1[A](program: Program[A]): A =
  program match
    case Ready(a) =&gt;
      a

    case FlatMap(program1, f) =&gt;
      val a1 = run1(program1) // not a tail call
      val program2 = f(a1)
      run1(program1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note this is a trivial straightforward implementation,
driven by types. You can&#8217;t do anything else with a <code>Program</code>
passed as argument than pattern-match it.
If it is a <code>Ready[A](a)</code>, the situation is trivial.
If it is a <code>FlatMap[B, A](program1, f)</code> for some type <code>B</code>,
a natural thing to do is to execute <code>program1: Program2[B]</code> to get a <code>B</code>,
apply <code>f</code> to get <code>program2: Program2[A]</code> and execute it to get <code>A</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s test our Collatz program against this interpreter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def collatz(n: BigInt): Program[BigInt] =
  Program.defer { () =&gt;
    if (n == 1) Program.ready(0)
    else {
      if (n % 2 == 0) collatz(n / 2).map(_ + 1)
      else collatz(3 * n + 1).map(_ + 1)
    }
  }

def printResult(n: BigInt) = suspend { () =&gt;
  println(s"Result: $n")
}

run1(collatz(6).flatMap(printResult))</code></pre>
</div>
</div>
<div class="paragraph">
<p>outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Result: 8</pre>
</div>
</div>
<div class="paragraph">
<p>If you inspect stack usage, you will see that execution of <code>collatz(6)</code>
by <code>run1</code> needs about 10 stack frames.
The reason is that during recursion we build a chain of <code>Map</code>s:
the <code>collatz(n)</code> gradually builds (from right) a program
<code>ready(0).map(_ + 1)[...].map(_ + 1)</code> which execution consumes a stack.
Let&#8217;s fix that.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tail_recursive_rewrite_of_naive_interpreter"><a class="anchor" href="#_tail_recursive_rewrite_of_naive_interpreter"></a>2.6. Tail-recursive rewrite of naive interpreter</h3>
<div class="paragraph">
<p>It needs some experience to rewrite stack-consuming
recursion to a tail-recursive one.
I applied my experience to <code>run1</code> and admittedly, this was a quite hard nut.
I finally and ended up with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">sealed trait Todo[B]
object Todo:
  case class Done[B](b: B) extends Todo[B]
  case class More[A, B](
      program: Program[A],
      todo: A =&gt; Todo[B],
  ) extends Todo[B]

@tailrec
def loop2[A, B](program: Program[A], todo: A =&gt; Todo[B]): B =
  import Todo._
  program match {
    case Ready(a) =&gt;
      todo(a) match {
        case Done(b)             =&gt; b
        case More(program, todo) =&gt; loop2(program, todo)
      }

    case FlatMap(program, f) =&gt;
      loop2(
        program,
        x =&gt; More(f(x), todo),
      )
  }

def run2[A](program: Program[A]): A =
  loop2(program, a =&gt; Todo.Done(a))</code></pre>
</div>
</div>
<div class="paragraph">
<p>As it is usual, we delegate the implementation of function we want
to make tail-recursive to a helper tail-recursive helper, here called
<code>loop2</code>.
(Note the <code>@tailrec</code> annotation which is here to make sure compiler
will use tail call elimination.)
The <code>todo</code> parameter is an accumulator of work &#8220;to be done&#8221;.
If we run our <code>collatz(n)</code> program against <code>run2</code> (with some debug logging),
we will see that tail calls are really eliminated.
Using <code>Program</code> with <code>run2</code> prevents stack overflows 🎉,
so already we can get something non-trivial for free.</p>
</div>
<div class="paragraph">
<p>Not so fast. We just moved to heap what previously was on stack,
the problem with chained <code>Map</code>s is not solved, only we can execute
the problem without overflowing the stack.</p>
</div>
<div class="sect3">
<h4 id="_example_compute_parity_of_length_of_list"><a class="anchor" href="#_example_compute_parity_of_length_of_list"></a>2.6.1. Example: compute parity of length of list</h4>
<div class="paragraph">
<p>We have a singly linked list, let&#8217;s write a program which computes
if its length is odd or even. A naive function version of this would be</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">/** Returns true if the `list` length is even. */
def even[A](list: List[A]): Boolean =
  list match
    case head :: tail =&gt; odd(tail)
    case Nil          =&gt; true

/** Returns true if the `list` length is odd. */
def odd[A](list: List[A]): Boolean =
  list match
    case head :: tail =&gt; even(tail)
    case Nil          =&gt; false

// use it
val list: List[Int] = ???
val hasEvenLength = even(list)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For larger lists, this will overflow the stack.
<code>Program</code> version will not as the control is always passed back
to interpreter before advancing to next step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">/** Returns true if the `list` length is even. */
def even[A](list: List[A]): Program[Boolean] = defer { () =&gt;
  list match
    case head :: tail =&gt; odd(tail)
    case Nil          =&gt; true
}

/** Returns true if the `list` length is odd. */
def odd[A](list: List[A]): Program[Boolean] = defer { =&gt;
  list match
    case head :: tail =&gt; even(tail)
    case Nil          =&gt; false
}

// use it
val list: List[Int] = ???
val hasEvenLength = run2(even(list))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The trick of not calling next step directly, but rather returning
a description what is to be done next is called <em>trampolining</em>,
and that&#8217;s what our <code>run2</code> does. By representing the term <em>program</em>
in code, we are a bit in the role of the programming language designer
or compiler implementor.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interpreter_of_program"><a class="anchor" href="#_interpreter_of_program"></a>2.7. Interpreter of <code>Program</code></h3>
<div class="paragraph">
<p>I hope it is clear how <code>run2</code> implements a tail-recursive interpreter
of <code>Program</code>s with the help of <code>Todo</code> variants <code>Done</code> and <code>More</code>.
But if we look more closely, there is a striking resemblance:
<code>Done</code> is like <code>Ready</code> and <code>More</code> is like <code>FlatMap</code>!
So we can rewrite <code>run2</code> to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">@tailrec
def run[A](program: Program[A]): A =
  program match {
    case Ready(a) =&gt;
      a

    case FlatMap(program, f) =&gt;
      program match
        case Ready(a) =&gt;
          run(f(a))

        case FlatMap(program, g) =&gt;
          run(FlatMap(program, a =&gt; FlatMap(g(a), f)))
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We could write this directly, but it might feel magic
which is something I wanted to avoid.
A bit of additional explanation:
In <code>case FlatMap</code>, we inline former <code>loop2</code> into the case body,
so pattern match on inner <code>FlatMap</code>'s program.
If the inner program is again a <code>FlatMap</code>, we move the function
&#8220;to the right&#8221;, removing one &#8220;onion peel&#8221; from the left, so that
we can continue with execution with smaller program: the equavality
here is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">FlatMap[B, A](
  FlatMap[C, B](
    program, // Program[C]
    g, // C =&gt; Program[B]
  ),
  f, // B =&gt; Program[A]
)
  ===
  FlatMap[C, A](
    program, // Program[C]
    h: (c: C) =&gt; FlatMap(
      g(c), // Program[B]
      f, // B =&gt; Program[A]
    ),
  )</code></pre>
</div>
</div>
<div class="paragraph">
<p>or written in dot-notation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">// where
val program: Program[C] = ???
val g: C =&gt; Program[B] = ???
val f: B =&gt; Program[A] = ???
// equivalence
program.flatMap { c =&gt; g(c) }.flatMap { b =&gt; f(b) }
  === program.flatMap { c =&gt; g(c).flatMap { b =&gt; f(b) } }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is sometimes called the <em>associativy (monad) law</em> since we can
symbolically write equivalence</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">[p &gt;&gt;= (c -&gt; g(c))] &gt;&gt;= (b -&gt; f(b)) === p &gt;&gt;= [c -&gt; (g(c) &gt;&gt;= (b -&gt; f(b)))]</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>&gt;&gt;=</code> stands for <code>flatMap</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.1<br>
Last updated 2021-07-07 22:40:36 +0200
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/scala.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/shell.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>